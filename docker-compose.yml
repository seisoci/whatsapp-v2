name: chat-ui

services:
  omnichat-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: omnichat-api
    restart: unless-stopped
    ports:
      - '127.0.0.1:3001:3001'
    environment:
      - TZ=Asia/Jakarta
      - PORT=${PORT:-3001}
      - NODE_ENV=${NODE_ENV:-production}
      - API_PREFIX=${API_PREFIX:-/api/v1}
      # Database
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE}
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-15m}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN:-7d}
      # Security
      - BCRYPT_ROUNDS=${BCRYPT_ROUNDS:-12}
      - MAX_LOGIN_ATTEMPTS=${MAX_LOGIN_ATTEMPTS:-5}
      - LOCK_TIME=${LOCK_TIME:-15}
      # Rate Limiting
      - AUTH_RATE_LIMIT_WINDOW=${AUTH_RATE_LIMIT_WINDOW:-15}
      - AUTH_RATE_LIMIT_MAX=${AUTH_RATE_LIMIT_MAX:-20}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
      # Redis
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      # MinIO
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-localhost}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET=${MINIO_BUCKET:-uploads}
      # WhatsApp
      - WHATSAPP_API_VERSION=${WHATSAPP_API_VERSION:-v21.0}
    networks:
      omnichat-network:
        ipv4_address: 172.20.0.2

  omnichat-ui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${NEXT_PUBLIC_TURNSTILE_SITE_KEY}
    container_name: omnichat-ui
    restart: unless-stopped
    ports:
      - '127.0.0.1:${NEXT_PORT:-3000}:${NEXT_PORT:-3000}'
    environment:
      - HOSTNAME=0.0.0.0
      - TZ=Asia/Jakarta
      - NEXT_PORT=${NEXT_PORT:-3000}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_API_PREFIX=${NEXT_PUBLIC_API_PREFIX:-/api/v1}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL}
      - NEXT_PUBLIC_TURNSTILE_SITE_KEY=${NEXT_PUBLIC_TURNSTILE_SITE_KEY}
    depends_on:
      - omnichat-api
    networks:
      omnichat-network:
        ipv4_address: 172.20.0.3

networks:
  omnichat-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
